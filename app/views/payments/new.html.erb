<!-- app/views/payments/new.html.erb -->

<h2>Make a Payment</h2>

<!-- The form for Stripe payment -->
<form id="payment-form">
  <div id="card-element">
    <!-- A Stripe Element will be inserted here. -->
  </div>

  <!-- Display any errors -->
  <div id="card-errors" role="alert"></div>

  <button id="submit" type="submit">Submit Payment</button>
</form>

<!-- Add your Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Stripe.js and Elements
  var stripe = Stripe('<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>');
  var elements = stripe.elements();
  var card = elements.create('card');
  card.mount('#card-element');

  var form = document.getElementById('payment-form');
  
  if (!form) {
    console.error('Form not found!');
    return; // Exit early if the form is not found
  }

  form.addEventListener('submit', function(event) {
    event.preventDefault();

    stripe.createToken(card).then(function(result) {
      if (result.error) {
        // Handle error
        var errorElement = document.getElementById('card-errors');
        errorElement.textContent = result.error.message;
      } else {
        // Handle token
        stripeTokenHandler(result.token);
      }
    });
  });

  // Handle the token submission to your server
  function stripeTokenHandler(token) {
    var form = document.getElementById('payment-form');
    
    // Check if the form exists
    if (form) {
      var hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);

      // Ensure the form is a valid form before submitting
      if (typeof form.submit === 'function') {
        form.submit();
      } else {
        console.error('form.submit is not a function');
      }
    }
  }
});

</script>
